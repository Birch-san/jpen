<!--
Copyright 2016 Nicolas Carranza <nicarran at gmail.com>

This file is part of jpen.

jpen is free software: you can redistribute it and/or modify
it under the terms of the GNU Lesser General Public License as published by
the Free Software Foundation, either version 3 of the License,
or (at your option) any later version.

jpen is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with jpen.  If not, see <http://www.gnu.org/licenses/>.
-->

<!--
WARNING: This Ant build file works right only on Linux.
-->

<!-- 
This Ant build file contains tasks for loading/creating/writing build properties.
-->
<project name="properties-build" default="updateNativeBuildHeaders">
	
	<target name="updateNativeBuildProperties" description="updates the nativeBuild.properties file">
		<exec executable="bash">
			<arg value="build-scripts/updateNativeBuildProperties.sh"/>
		</exec>
	</target>
	
	<target name="updateBuildProperties" depends="updateNativeBuildProperties" description="updates the build.properties file and loads module/nativeBuild/build.properties values" unless="module.id">
		
		<!-- module.properties contains module.id -->
		<property file="module.properties"/> 
		<property file="nativeBuild.properties"/>
		
		<property name="module.url" value="UNDEFINED"/>
		<property name="module.commercialId" value="${module.package}"/>
		<exec executable="bash" outputproperty="module.version">
			<arg value="build-scripts/getVersion.sh"/>
			<arg value="${module.fullVersion}"/>
		</exec>
		<property name="module.id-ver" value="${module.id}-${module.version}"/>
		<property name="module.id-fullVer" value="${module.id}-${module.fullVersion}"/>
		<property name="module.package-ver" value="${module.package}-${module.version}"/>
		
		<echoproperties destfile="build.properties.tmp" regex="(module.*)|(${module.id}.*)|(doc.*)"/>
		<echo file="build.properties.out"># DO NOT EDIT THIS FILE - it is generated by ant
</echo>
		<exec executable="grep" output="build.properties.out" append="true">
			<arg line="= build.properties.tmp"/>
		</exec>
		<move file="build.properties.out" tofile="src/main/resources/${module.packageAsDir}/build.properties"/>
		<delete file="build.properties.tmp" />
		<exec executable="ln" os="Linux">
			<arg value="-sfT"/>
			<arg value="src/main/resources/${module.packageAsDir}/build.properties"/>
			<arg value="build.properties"/>
		</exec>
	</target>
	
	<target name="readBuildProperties" description="loads the build/build-user.properties values" depends="updateBuildProperties"> 
		<property file="build-user.properties"/> 
		<property file="build.properties"/>
	</target>
	
	<target name="updateNativeBuildHeaders" depends="readBuildProperties" description="updates the native header files using the *.nativeBuild property values">
		<echo file="src/main/c/nativeBuild/linux-BuildNumber.h">
/* DO NOT EDIT THIS FILE - it is machine generated */
#ifndef BuildNumber_h
#define BuildNumber_h
#define BUILD_NUMBER ${jpen.provider.xinput.nativeBuild} 
#endif
</echo>
		<echo file="src/main/c/nativeBuild/windows-BuildNumber.h">
/* DO NOT EDIT THIS FILE - it is machine generated */
#ifndef BuildNumber_h
#define BuildNumber_h
#define BUILD_NUMBER ${jpen.provider.wintab.nativeBuild}
#endif
</echo>
		<echo file="src/main/c/nativeBuild/osx-BuildNumber.h">
/* DO NOT EDIT THIS FILE - it is machine generated */
#ifndef BuildNumber_h
#define BuildNumber_h
#define BUILD_NUMBER ${jpen.provider.osx.nativeBuild}
#endif
</echo>
	</target>

</project>